__NUXT_JSONP__("/projects", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac){return {data:[{pages:[{slug:"air-quality-monitor-2",description:"Continuing work on my air quality monitoring device",title:"An Air Quality Update",published:x,tags:"arduino, hardware, iot, environment",cover_image:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F3bmgyx4dkjyngzb1dwx3.jpg",date:"2019-06-21T00:00:00.000Z",toc:[{id:y,depth:p,text:z},{id:A,depth:p,text:B},{id:C,depth:p,text:D},{id:E,depth:p,text:F},{id:G,depth:p,text:H},{id:I,depth:p,text:J},{id:K,depth:p,text:L}],body:{type:M,children:[{type:b,tag:d,props:{},children:[{type:a,value:"A few weeks back I showed you "},{type:b,tag:e,props:{href:N,rel:[f,g,h],target:i},children:[{type:a,value:"my air quality monitoring device"}]},{type:a,value:". I've since tweaked it, ran into problems and fixed them, and added some functionality. I also gathered some interesting data using the sensor itself - and it might be a little surprising."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Finally, I posted the source code for the program running on the ESP32 as a "},{type:b,tag:e,props:{href:O,rel:[f,g,h],target:i},children:[{type:a,value:"GitHub Gist"}]},{type:a,value:" - there's more on it below."}]},{type:a,value:c},{type:b,tag:q,props:{id:y},children:[{type:b,tag:e,props:{href:"#adding-some-stability-of-the-mechanical-kind",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:z}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"To prevent the components from rattling around too much inside the enclosure, I designed a backing board in Fusion 360 and used the laser cutter at the South London Makerspace. This is just a piece of plywood with some holes, allowing me to secure the SDS-011 sensor and the ESP32 breakout board with some nylon screws. I went through a couple of design iterations of these backing boards, trying to fit everything inside the enclosure I had. The final one (highlighted in the screenshot below) packs the components in about 2\u002F3rd of the enclosure, allowing the battery holder to stand on its side as was the case when everything was wibble-wobbling around in the box."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Fusion 360 screenshot",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fsauohsmzudnuoyh9agni.png"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Needless to say, the wibble-wobbling was reduced and the pieces are now much easier to work with if I ever need to take them out of the box."}]},{type:a,value:c},{type:b,tag:q,props:{id:A},children:[{type:b,tag:e,props:{href:"#batteries-included",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:B}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Ah yes, the battery compartment - which I previously used as just a power supply - is now occupied by actual batteries. I sourced those from Poundland power banks, at about Â£2 per ~2000mAh cells. They are pretty easy to get hold of, although I'm pretty sure one of these came pre-shorted - it started getting a bit smoky whenever I put any load on it. PSA: "},{type:b,tag:t,props:{},children:[{type:a,value:"If your batteries get smoky, don't use them!"}]},{type:a,value:" Lithium batteries are usually quite safe, but if you short them out, they can catch fire and\u002For explode, so it's best to not mess about with them."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I also wanted to be able to measure the level of charge in the batteries. The problem I needed to overcome was that, at full charge, a Li-ion battery (or a couple of them in parallel) has a potential of up to 4.3V - which is a full volt higher than the 3.3V level that the ESP32 operates at. I needed to get the battery voltage coming into an analogue pin of the ESP32 to top out at or below 3.3v in order to measure it without damaging the microcontroller. I can drop the voltage by using a voltage divider. I built an example of the circuit "},{type:b,tag:e,props:{href:"http:\u002F\u002Ftinyurl.com\u002Fyxp8ku24",rel:[f,g,h],target:i},children:[{type:a,value:"here"}]},{type:a,value:" in a simulator where you can play around with the battery voltage and see how the divider circuit:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:u,src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Ffl0thmsepdqddn7gvsf6.png"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"In the code, I define one of the pins as an analogue pin, and configure the ADC using some ESP32\u002FArduino functions. I can then read from this pin using the normal "},{type:b,tag:r,props:{},children:[{type:a,value:"analogRead"}]},{type:a,value:" function. However, when measuring an analogue value, noise and error creeps in pretty fast - so I decided to measure the battery level several times and average the results:"}]},{type:a,value:c},{type:b,tag:P,props:{className:[Q]},children:[{type:b,tag:R,props:{className:[S,T]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"\u002F\u002F setup:\n  adcAttachPin(BATTERY_PIN);\n  analogSetPinAttenuation(BATTERY_PIN, ADC_11db);\n\n\u002F\u002F measure:\nfloat get_battery(int n_samples) {\n  float sum_reading = 0.0;\n  for (int n = 0; n \u003C n_samples; n++) {\n    int batteryAdcCount = analogRead(BATTERY_PIN);\n    \u002F\u002F Battery voltage is given by the ADC as x\u002F4096 * 3.3 for the voltage divider\n    \u002F\u002F and * 2 for the full voltage.\n    sum_reading += ((float) batteryAdcCount) \u002F 4096.0 * 3.3 * 2;\n  }\n\n  return sum_reading \u002F ((float) n_samples);\n}\n"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"There is a certain dialectic when it comes to measuring battery levels. The ADC is not magic, and it requires some current to flow while the measurement is taking place. However, you don't want that current to be too high, otherwise you'd be draining the battery rather quickly. This is where the choice of resistor value in your voltage divider is important - too low and you'll burn through the battery, too high and you might not be able to measure it accurately. I picked 36kOhm for mine at pretty much random, but it's high enough that the total current flowing through the divider is about 60uA. Compared to the SDS-011 and ESP32 running at full tilt (peaking at 270mA), it's not very much. If I was crazy about power efficiency, I would experiment more with higher resistor values, and possibly add a transistor to the circuit, so that I can turn off the current if I'm not currently measuring voltage."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"In the end, the battery measurement works pretty well, and the battery itself seems to last at least two full days:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Voltage graph showing the battery discharging",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F11lrqcaz5yuh8aknr4mh.png"},children:[]}]},{type:a,value:c},{type:b,tag:q,props:{id:C},children:[{type:b,tag:e,props:{href:"#on-plugging-in-stuff-wrong",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:D}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I semi-broke an ESP32 board during the development of this by accidentally plugging it with one pin shifted down in the socket, causing 5V to be applied to its ground pin. Somehow it survived that, but not unscathed - that particular board will no longer wake up from any form of CPU sleep without an external reset, but does otherwise work. Oops. Luckily, I had a spare that worked."}]},{type:a,value:c},{type:b,tag:q,props:{id:E},children:[{type:b,tag:e,props:{href:"#how-to-sleep-right",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:F}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Turns out I was using the sleep modes of the ESP32 wrong. Initially I thought of ESP's light sleep as a special case of the Arduino "},{type:b,tag:r,props:{},children:[{type:a,value:"delay()"}]},{type:a,value:" function, except where the processor core powers down for the duration of the delay. It's kind of like that, but with one caveat: this also suspends handling of the WiFi connection, causing some instability."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Furthermore, the ESP also has a deep sleep mode which saves more power, but it actually resets the microcontroller when waking up. I decided that I should use this mode, though - I don't need WiFi between measurements, so I might as well turn everything off. It also simplified the code slightly - I could put everything in "},{type:b,tag:r,props:{},children:[{type:a,value:"setup()"}]},{type:a,value:" and rely on the wakeup resets."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"This also made the whole system more stable, and allowed me to more easily add retry features - in the version of the gist current at the time of writing ("},{type:b,tag:e,props:{href:"https:\u002F\u002Fgist.github.com\u002FFLamparski\u002F93af1ac4f49c2fde550a36f14a0d9446\u002F43b1ba31f619c24c3319f1d5bf3f93049d5d6633",rel:[f,g,h],target:i},children:[{type:a,value:"permalink"}]},{type:a,value:"), if I can't connect to WiFi within a few seconds, I turn everything off and sleep for another 15 seconds. Now, this is still a bit buggy - there can be long stretches when the ESP can't connect at all - so I will need to look at the timeout and other causes of connectivity issues. However, the device will "},{type:b,tag:U,props:{},children:[{type:a,value:"eventually"}]},{type:a,value:" reconnect without me having to go and reset it."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Nope, didn't need that data today...",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fcfvsj91nirc2j9hh152x.png"},children:[]}]},{type:a,value:c},{type:b,tag:q,props:{id:G},children:[{type:b,tag:e,props:{href:"#some-actual-observations",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:H}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"PM2.5 of the carbon species usually comes from burning stuff, right? Well, how about toast? Or indeed, just cooking lunch?"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Lunchtime spike",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fip1t8u9ve5wugi0z0rmm.png"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Most nights I see a significant increase in presence of PM2.5 species over the night, even though traffic outside my apartment is very light - could this be due to some scattered light affecting the SDS-011 sensor? Or temperatures going down causing dust kicked up high into the atmosphere during the day to settle down?"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"High measurements overnight",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fdyf08orhdvr3xc3mwpzw.png"},children:[]}]},{type:a,value:c},{type:b,tag:q,props:{id:I},children:[{type:b,tag:e,props:{href:"#for-those-playing-along",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:J}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The "},{type:b,tag:e,props:{href:O,rel:[f,g,h],target:i},children:[{type:a,value:"gist"}]},{type:a,value:" contains the Arduino sketch running on the ESP32 inside the device. If you want to run it on your own network, you will need to change the WiFi credentials near the top of the file:"}]},{type:a,value:c},{type:b,tag:P,props:{className:[Q]},children:[{type:b,tag:R,props:{className:[S,T]},children:[{type:b,tag:r,props:{},children:[{type:a,value:"#define WIFI_SSID \"CHANGE ME\"\n#define WIFI_PASS \"CHANGE ME\"\n"}]}]}]},{type:a,value:c},{type:b,tag:q,props:{id:K},children:[{type:b,tag:e,props:{href:"#as-always-theres-more",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:L}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The most obvious next step will be to figure out why the ESP is not connecting to WiFi - maybe it's the internal antenna not being very good, or the timeout being too short."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Further next steps would be figuring out how to control my measurements for things like cooking - if I am going to use this device to nag my local authority, I should be reasonably sure that the data I get out of it is down to actual traffic related pollution, and not me burning toast. Finally, I should write up that IoT server setup, shouldn't I..."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"See you then - and as always, let me know what you think about this project. I'm still liking it a lot."}]}]},dir:V,path:"\u002Fprojects\u002Fair-quality-monitor-2",extension:W,createdAt:"2021-05-03T12:33:11.073Z",updatedAt:"2021-05-03T13:15:25.029Z"},{slug:"air-quality-monitor",description:"I am making an air quality monitoring station. Here I walk you through my basic setup.",title:"Working on my IoT air quality monitoring setup",published:x,tags:"environment, arduino, monitoring, hardware",cover_image:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fhpdc73eh88xd8xlfpyho.jpg",date:"2019-06-05T00:00:00.000Z",toc:[],body:{type:M,children:[{type:b,tag:d,props:{},children:[{type:b,tag:t,props:{},children:[{type:a,value:"This post originally appeared on "},{type:b,tag:e,props:{href:N,rel:[f,g,h],target:i},children:[{type:a,value:"dev.to"}]}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Air quality - much has been said about it in the recent years. Research is coming out saying that breathing polluted air "},{type:b,tag:e,props:{href:"https:\u002F\u002Fwww.who.int\u002Fairpollution\u002Fambient\u002Fhealth-impacts\u002Fen\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"contributes to risk of asthma attacks, allergies, and other health issues"}]},{type:a,value:". One of the most common pollutants is particulate matter - very fine carbon dust emitted from diesel and some petrol engines. If you live near a high traffic road, you are likely breathing some in right now - and it might be giving you black lung in slow motion."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"On an unrelated note, here's a view from my window:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Look at all those lorries",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fktdzv38r0c5runm29ghc.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I would like to know how much of this dust - more technically, particulate matter, is in the air outside my window throughout the day. The end goal is to use this information to set up alerts if and when pollution levels exceed government targets, and use this to keep my local authority accountable."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"So, how do I start?"}]},{type:a,value:c},{type:b,tag:s,props:{id:"the-sds-011-sensor"},children:[{type:b,tag:e,props:{href:"#the-sds-011-sensor",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"The SDS-011 Sensor"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Product shot of the SDS-011, showing the included USB adapter",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F8ckn52lit1sl3gw5yzys.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The heart of the operation is the nova SDS-011 sensor. It works by blowing air past a laser beam and looking for scattered reflections. It can then isolate scattering caused by specific types of particulate matter - PM2.5 and PM10 - and measure how much of it is in the air, giving its reading in micrograms per cubic metre."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The sensors are pretty cheap - less than Â£20 on "},{type:b,tag:e,props:{href:"https:\u002F\u002Fwww.aliexpress.com\u002Fwholesale?catId=0&initiative_id=SB_20190605020754&SearchText=sds011",rel:[f,g,h],target:i},children:[{type:a,value:"AliExpress"}]},{type:a,value:", with roughly similar prices on Banggood and eBay if shipped from China. Some also throw in a USB adapter for the sensor's serial (UART) interface. Neat! What's not neat is the up to 3 week shipping time, but that's just par for the course when ordering from China."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"By default, the sensor will output its measurements continuously every second. This can be useful if you want to test that it is working with the USB adapter. In fact, I wrote some Python programs that rely on this mode to display the sensor's readings. The simplest one is here in its entirety:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:v},{type:b,tag:e,props:{href:X,rel:[f,g,h],target:i},children:[{type:a,value:X}]},{type:a,value:w}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"If you also want to plot this data immediately, here's one with matplotlib: "},{type:b,tag:e,props:{href:Y,rel:[f,g,h],target:i},children:[{type:a,value:Y}]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Great, now I have some data coming in! But I don't want the sensor to be connected to my computer, I'd like to connect it to an ESP32 microcontroller (I have some of these around which I might as well use)."}]},{type:a,value:c},{type:b,tag:s,props:{id:"the-esp32"},children:[{type:b,tag:e,props:{href:"#the-esp32",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"The ESP32"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Close-up shot of an ESP32 development board",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F9dbl0ko0gekb516jw8p5.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The ESP32 is a crazy powerful Wi-Fi microcontroller - with the most common variant boasting a dual-core 240MHz CPU, 2 or 4 MiB of flash memory, and 520 KiB of RAM. It's also largely Arduino compatible - and the board library is developed by Espressif as a first-party product."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"It's also really cheap for all that power: you can get it for under Â£7 with Amazon Prime delivery (or look at the "},{type:b,tag:e,props:{href:"https:\u002F\u002Fsmile.amazon.co.uk\u002Fs?k=esp32",rel:[f,g,h],target:i},children:[{type:a,value:"amazon search"}]},{type:a,value:" for variants with OLED displays, camera attachments, LiPo chargers, etc on board)."}]},{type:a,value:c},{type:b,tag:s,props:{id:"the-one-where-i-almost-burn-myself-with-a-soldering-iron"},children:[{type:b,tag:e,props:{href:"#the-one-where-i-almost-burn-myself-with-a-soldering-iron",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"The one where I almost burn myself with a soldering iron"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"To connect the SDS-011 to the ESP32, I am using a perfboard - a PCB with a grid of holes in it, allowing you to quickly assemble your circuit without having to design and make a dedicated PCB. I also needed a 5-pin JST connector to take in the cable supplied with the USB adapter, and I also decided to make a socket for my ESP32 from two pieces of female dupont pin headers. This makes the ESP board stand off from the perfboard, giving me some space to work with underneath it, and also allows me to easily recover the ESP if I ever tear this project down."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I then soldered some jumper wires on the back side of the board for power and to connect the TX pin of the SDS-011 to the RX2 pin of the ESP, and RX of the SDS-011 to the TX2 pin of the ESP. I made an image in gimp to help me route the wires correctly:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Perfboard routing guide",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F71g5na42p14bagihv7cp.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"TX2 and RX2 on the ESP board are available as Serial2 in Arduino sketches. The observant among you may have noticed an extra JST connector exposing the I2C bus - this is for later."}]},{type:a,value:c},{type:b,tag:s,props:{id:"lol-embedded-programming"},children:[{type:b,tag:e,props:{href:"#lol-embedded-programming",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"Lol embedded programming"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"This is not strictly speaking a tutorial, so I'll gloss over how to actually set up ESP32 boards in Arduino - this is documented in the "},{type:b,tag:e,props:{href:"https:\u002F\u002Fgithub.com\u002Fespressif\u002Farduino-esp32\u002Fblob\u002Fmaster\u002Fdocs\u002Farduino-ide\u002Fboards_manager.md",rel:[f,g,h],target:i},children:[{type:a,value:"arduino-esp32 project itself"}]},{type:a,value:". The one thing you should note is that this only works with the "},{type:b,tag:t,props:{},children:[{type:a,value:"desktop"}]},{type:a,value:" Arduino IDE, and only if you install the IDE through the MSI installer and "},{type:b,tag:t,props:{},children:[{type:a,value:"not from Windows Store"}]},{type:a,value:Z}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"A very simple sketch, which simply formats the incoming data as text and outputs it to the debug serial connection, is also quite short:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:v},{type:b,tag:e,props:{href:_,rel:[f,g,h],target:i},children:[{type:a,value:_}]},{type:a,value:w}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"So after verifying that this works, I wanted to hunt down some more complete documentation of the SDS-011. The reason for that is that you are not supposed to run the sensor continuously for a long period of time, as it will allow dust of all kinds to accumulate inside, causing it to lose accuracy over time. The manufacturer states that the expected useful lifetime is 8000 hours of operation - so if you don't operate it all the time, you'll get more chooch for your cash. The other reason is that I'd like to run the thing off of lithium batteries at some point, and the SDS-011 uses about a Watt of power when it's running, what with its laser and fan."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"There is a good Arduino library for the SDS family of sensors, which supports the complete protocol they use and presents a nice API for it: "},{type:b,tag:e,props:{href:$,rel:[f,g,h],target:i},children:[{type:a,value:$}]},{type:a,value:". The protocol documentation is "},{type:b,tag:U,props:{},children:[{type:a,value:"an absolute pig"}]},{type:a,value:" to find though, and I ended up emailing the manufacturer for it. The v1.5 spec is here: "},{type:b,tag:e,props:{href:aa,rel:[f,g,h],target:i},children:[{type:a,value:aa}]},{type:a,value:". If you're implementing your own interface to the sensor, make sure to get the checksum right, otherwise it won't process your commands, and it won't tell you why either. I wrote this before I became aware of that library:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:v},{type:b,tag:e,props:{href:ab,rel:[f,g,h],target:i},children:[{type:a,value:ab}]},{type:a,value:w}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"When it's mostly wired up, it looks like this:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Photo of the assembled setup in an enclosure box",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Ffe0v65vu9fmric2x62ux.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I'm powering it through a charge port I hot glued onto the battery compartment."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"At this point, I can start sending all this data to a server. I decided to use an old laptop that I had in my cupboard."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"There is a big gotcha when using the SDS library with the ESP32: It will fail to compile due to "},{type:b,tag:r,props:{},children:[{type:a,value:ac}]},{type:a,value:" not being available in the ESP32 Arduino board package. To remedy that, I downloaded the master branch of the library and put it in my Arduino libraries folder, and then deleted all the code that relied on "},{type:b,tag:r,props:{},children:[{type:a,value:ac}]},{type:a,value:Z}]},{type:a,value:c},{type:b,tag:s,props:{id:"cant-spell-idiot-without-iot"},children:[{type:b,tag:e,props:{href:"#cant-spell-idiot-without-iot",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"Can't spell idiot without IoT"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"The server is running "},{type:b,tag:e,props:{href:"https:\u002F\u002Fwww.influxdata.com\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"InfluxDB"}]},{type:a,value:", "},{type:b,tag:e,props:{href:"https:\u002F\u002Fnodered.org\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"Node-RED"}]},{type:a,value:", and "},{type:b,tag:e,props:{href:"https:\u002F\u002Fgrafana.com\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"Grafana"}]},{type:a,value:" inside Docker. It's also running "},{type:b,tag:e,props:{href:"https:\u002F\u002Fmosquitto.org\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"Mosquitto"}]},{type:a,value:" as the MQTT broker, and "},{type:b,tag:e,props:{href:"https:\u002F\u002Fgithub.com\u002Fportainer\u002Fportainer",rel:[f,g,h],target:i},children:[{type:a,value:"Portainer"}]},{type:a,value:" to give me a nice GUI to the Docker host. And of course, I'm also monitoring the server itself with "},{type:b,tag:e,props:{href:"https:\u002F\u002Fwww.influxdata.com\u002Ftime-series-platform\u002Ftelegraf\u002F",rel:[f,g,h],target:i},children:[{type:a,value:"Telegraf"}]},{type:a,value:" running directly on the host. This setup is largely based on "},{type:b,tag:e,props:{href:"https:\u002F\u002Fwww.youtube.com\u002Fchannel\u002FUCu7_D0o48KbfhpEohoP7YSQ",rel:[f,g,h],target:i},children:[{type:a,value:"Andreas Speiss"}]},{type:a,value:"'s Raspberry Pi configuration from his videos, however you can mix and match different components - for instance, a friend of mine is using Prometheus instead to monitor her "},{type:b,tag:e,props:{href:"https:\u002F\u002Fslides.com\u002Fdaisyt\u002Fobservability-kitchen",rel:[f,g,h],target:i},children:[{type:a,value:"sourdough cultures"}]},{type:a,value:" on a RPi."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"This took a while to set up, not least because I was following several different sources at the same time, many of them written for the RPi and not an x86 machine. However it is mostly working now - and when I'm done tweaking the setup, I will release it on github as a docker-compose application."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"But finally, I was able to connect to the MQTT broker from my ESP32 and start sending data..."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Haha, no. The PubSubClient library I use to connect to the server has a default timeout of 15 seconds, which is way too low for my use case - given that I take about 15 seconds to wake up the sensor and then gather measurement data to average out, and spend another 15 with the CPU sleeping to reduce power use. So I just went into the library and changed the keepalive interval to something more reasonable, like 3 minutes. Afterwards, I started getting data in much more reliably, however the MQTT connection is still kinda patchy and I want to fix that before I move on to adding more sensors to the thing."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"In the end though, I get a good amount of data through, which I can see on my Grafana dashboard:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:"Dashboard showing that a lot of emissions happen at night",src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002F97zdi60t3dochty0u7fk.png"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"For completeness, here's the Node-RED flow:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:u,src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fdts5hkztljo5x6347nv9.png"},children:[]}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"And a photo of the setup sucking in air from outside my window to analyse:"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:b,tag:o,props:{alt:u,src:"https:\u002F\u002Fthepracticaldev.s3.amazonaws.com\u002Fi\u002Fs86ag0q1pn5ho69tajqm.jpg"},children:[]}]},{type:a,value:c},{type:b,tag:s,props:{id:"more-stuff"},children:[{type:b,tag:e,props:{href:"#more-stuff",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"More stuff?"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"For further development, I will definitely need to fix the MQTT connection. I don't know what's going on, but sometimes the ESP just plain can't connect to the server, or data gets eaten somewhere in the process. It might be a slightly too aggressive application of sleep modes, or maybe I need to tweak my WiFi settings. This is the challenge of debugging distributed systems - you just plain don't know where the problem actually is, and more often than not, it's actually many problems in many places."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I also want to actually power the thing off of batteries. I have some 18650 lithium cells I bought at very reasonable prices as Poundland powerbanks (Â£2 per ~2000mAh cell at a brick and mortar store in the UK? And you get some charge circuitry with it? That's super cheap for hobbyists!), and a holder with appropriate charge circuitry."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Once I assemble all of that, the box can be made mostly safe against rain water ingress with an O-ring seal along the top and some shrouding of the air inlet and outlet ports. Then I can put it outside and actually close my window."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"Finally, I can also add some I2C sensors for general weather stuff - such as the ever popular BME280. I also thought about adding a display and some sort of touch sensitive pad stuck to the underside of the enclosure cover (which is transparent) to read data directly from the thing, but I think the Grafana interface is nicer."}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"And perhaps one day I'll design a cost reduced solution for all of this with a dedicated circuit board and put it up online for people to buy. If I can get the whole thing down to less than Â£30 I'd be quite happy. Yes, I will add better security if I ever sell this design, don't worry!"}]},{type:a,value:c},{type:b,tag:s,props:{id:"closing-thoughts-for-now"},children:[{type:b,tag:e,props:{href:"#closing-thoughts-for-now",ariaHidden:j,tabIndex:k},children:[{type:b,tag:l,props:{className:[m,n]},children:[]}]},{type:a,value:"Closing thoughts for now"}]},{type:a,value:c},{type:b,tag:d,props:{},children:[{type:a,value:"I like this project. I want to know how much crap I'm breathing in and I now can. I like how this is a nice practical way to consolidate knowledge I learned at uni in two or three separate modules. And I like how quickly I can prototype all of this. I think you should try something like this too - dev hardware is super cheap these days and software is free and relatively straightforward to put together. Electronics knowledge is also easy to obtain on the internet, and proper tools are reasonably priced. Go do the thing!"}]}]},dir:V,path:"\u002Fprojects\u002Fair-quality-monitor",extension:W,createdAt:"2021-05-03T12:30:26.508Z",updatedAt:"2021-05-03T13:15:12.918Z"}]}],fetch:{},mutations:void 0}}("text","element","\n","p","a","nofollow","noopener","noreferrer","_blank","true",-1,"span","icon","icon-link","img",2,"h2","code","h1","strong","","{% gist "," %}",true,"adding-some-stability-of-the-mechanical-kind","Adding some stability, of the mechanical kind","batteries-included","Batteries included","on-plugging-in-stuff-wrong","On plugging in stuff wrong","how-to-sleep-right","How to sleep right","some-actual-observations","Some actual observations","for-those-playing-along","For those playing along","as-always-theres-more","As always, there's more","root","https:\u002F\u002Fdev.to\u002Fminkovsky\u002Fworking-on-my-iot-air-quality-monitoring-setup-40a5","https:\u002F\u002Fgist.github.com\u002FFLamparski\u002F93af1ac4f49c2fde550a36f14a0d9446","div","nuxt-content-highlight","pre","language-text","line-numbers","em","\u002Fprojects",".md","https:\u002F\u002Fgist.github.com\u002FFLamparski\u002F6e5e673b165f19d3e9c5f4b88f0d1ab2","https:\u002F\u002Fgist.github.com\u002FFLamparski\u002Fc9d09153183f77c69f8c8ca7ca22e7ab#file-plot-py",".","https:\u002F\u002Fgist.github.com\u002FFLamparski\u002F25a39a8f5a1c4b3535fe67d7ca39b0ea","https:\u002F\u002Fgithub.com\u002Flewapek\u002Fsds-dust-sensors-arduino-library","https:\u002F\u002Fdrive.google.com\u002Fopen?id=0B11dfFBNOar5NHNTUVlvcFJPWUctMWZzYWRZU0RiMWxheG04","https:\u002F\u002Fgist.github.com\u002FFLamparski\u002Fc11a2817351ede4b6c3f2f81d0cd99ca","SoftwareSerial")));