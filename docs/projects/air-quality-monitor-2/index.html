<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>An Air Quality Update - Projects - Filip Wieland</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" data-hid="charset" charset="utf-8"><meta data-n-head="ssr" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="ssr" data-hid="apple-mobile-web-app-title" name="apple-mobile-web-app-title" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="ssr" data-hid="og:title" name="og:title" property="og:title" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:description" name="og:description" property="og:description" content="```bash # install dependencies $ npm install"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="preconnect" href="https://fonts.gstatic.com"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&display=swap"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap"><link data-n-head="ssr" data-hid="shortcut-icon" rel="shortcut icon" href="/_nuxt/icons/icon_64x64.5f6a36.png"><link data-n-head="ssr" data-hid="apple-touch-icon" rel="apple-touch-icon" href="/_nuxt/icons/icon_512x512.5f6a36.png" sizes="512x512"><link data-n-head="ssr" rel="manifest" href="/_nuxt/manifest.8d173111.json" data-hid="manifest"><link rel="preload" href="/_nuxt/f13c776.js" as="script"><link rel="preload" href="/_nuxt/46dd145.js" as="script"><link rel="preload" href="/_nuxt/6bbb62c.js" as="script"><link rel="preload" href="/_nuxt/32e3f4c.js" as="script"><link rel="preload" href="/_nuxt/b629c88.js" as="script"><style data-vue-ssr-id="4a42b2dc:0 517a8dd7:0 fa7ff0ca:0 248ac8c2:0 e3941c4a:0 4f95ad5b:0 254b2fa9:0">*,:after,:before{box-sizing:border-box;margin:0}body,html{margin:0;padding:0;font-family:Bahnschrift,"Roboto Condensed",-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:14px;font-weight:400;line-height:1.2;background-color:#000;color:#fff}.text-heading,h1,h2,h3,h4,h5,h6{font-family:Montserrat,Bahnschrift,"Roboto Condensed",-apple-system,BlinkMacSystemFont,"Open Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.4;margin-bottom:.5em}ol,p,ul{margin-bottom:.5em}ul{padding-left:16px}.__layout,.__nuxt,body,html{height:100%}a{text-decoration:none;color:#db28aa}main a{text-decoration:underline}a:visited{color:#b54e99}a:hover,a:visited:hover{color:#ea7fcd}.text-grey{color:#888}code,kbd,pre,span.text-code,textarea{font-size:14px;line-height:1.2;font-family:"Cascadia Code",Inconsolata,"Source Code Pro",Monaco,Menlo,"Courier New",Courier,monospace}main img{max-width:100%}.nuxt-content blockquote{border-left:2px solid #888;padding-left:1em}.nuxt-content .pullout{float:right;max-width:250px;margin-left:1em}.nuxt-content .pullout>img{display:block}.nuxt-content .pullout>img+.caption{margin-top:4px;font-style:italic}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.layout-projects[data-v-5e315e0e]{background-color:#471d00;height:100vh}.layout-projects .layout-inner[data-v-5e315e0e]{padding:16px;height:calc(100% - 48px);overflow:auto}.navbar[data-v-5875e95e]{display:flex;flex-direction:row;background-color:#000;color:#fff;height:48px;align-items:center}.navbar .link-heading-container[data-v-5875e95e]{flex:3}.navbar .link-heading[data-v-5875e95e]{margin-left:16px;color:#fff}.navbar .link-heading[data-v-5875e95e]:hover,.navbar .link-heading[data-v-5875e95e]:visited{color:#fff}.navbar .link-to-theme[data-v-5875e95e]{flex:1;padding:0 16px;height:100%;display:flex;flex-direction:column;justify-content:center;text-align:center}@media screen and (max-width:400px){.navbar .link-to-theme[data-v-5875e95e]{font-size:12px;padding:0 8px}}.link-to-theme[data-v-fba9cf46]{text-decoration:none;text-transform:uppercase}.link-to-theme.theme-code[data-v-fba9cf46]{background-color:#6049ff;color:#e6e2ff}.link-to-theme.theme-code[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-code.active[data-v-fba9cf46],.link-to-theme.theme-code[data-v-fba9cf46]:hover,.link-to-theme.theme-code[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#1d00e2;box-shadow:inset 0 0 5px 2px rgba(16,0,124,.8);transition:.3s}.link-to-theme.theme-code[data-v-fba9cf46]:visited{color:#e6e2ff}.link-to-theme.theme-music[data-v-fba9cf46]{background-color:#1a9e11;color:#64ed5b}.link-to-theme.theme-music[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-music.active[data-v-fba9cf46],.link-to-theme.theme-music[data-v-fba9cf46]:hover,.link-to-theme.theme-music[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#0b4207;box-shadow:inset 0 0 5px 2px rgba(0,0,0,.8);transition:.3s}.link-to-theme.theme-music[data-v-fba9cf46]:visited{color:#64ed5b}.link-to-theme.theme-projects[data-v-fba9cf46]{background-color:#e05c00;color:#ffb17a}.link-to-theme.theme-projects[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-projects.active[data-v-fba9cf46],.link-to-theme.theme-projects[data-v-fba9cf46]:hover,.link-to-theme.theme-projects[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#7a3200;box-shadow:inset 0 0 5px 2px rgba(20,8,0,.8);transition:.3s}.link-to-theme.theme-projects[data-v-fba9cf46]:visited{color:#ffb17a}.link-to-theme .text-heading[data-v-fba9cf46]{margin-bottom:0}.page[data-v-63ca4eb8]{margin:0 auto 20px;width:100%;max-width:640px}</style><link rel="preload" href="/_nuxt/static/1654546987/projects/air-quality-monitor-2/state.js" as="script"><link rel="preload" href="/_nuxt/static/1654546987/projects/air-quality-monitor-2/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1654546987/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="layout-projects" data-v-5e315e0e><div class="navbar" data-v-5875e95e data-v-5e315e0e><div class="link-heading-container" data-v-5875e95e><a href="/" class="text-heading link-heading nuxt-link-active" data-v-5875e95e>Filip Wieland</a></div> <a href="/code" class="link-to-theme theme-code" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Code
    </span></a><a href="/music" class="link-to-theme theme-music" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Music
    </span></a><a href="/projects" class="link-to-theme nuxt-link-active theme-projects active" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Projects
    </span></a></div> <div class="layout-inner" data-v-5e315e0e><div class="page" data-v-63ca4eb8 data-v-5e315e0e><a href="/projects" class="nuxt-link-active" data-v-63ca4eb8>Projects <span class="text-grey" data-v-63ca4eb8>/</span></a> <h1 data-v-63ca4eb8>An Air Quality Update</h1> <main data-v-63ca4eb8><div class="nuxt-content" data-v-63ca4eb8 data-v-63ca4eb8><p data-v-63ca4eb8 data-v-63ca4eb8>A few weeks back I showed you <a href="https://dev.to/minkovsky/working-on-my-iot-air-quality-monitoring-setup-40a5" rel="nofollow noopener noreferrer" target="_blank" data-v-63ca4eb8 data-v-63ca4eb8>my air quality monitoring device</a>. I've since tweaked it, ran into problems and fixed them, and added some functionality. I also gathered some interesting data using the sensor itself - and it might be a little surprising.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>Finally, I posted the source code for the program running on the ESP32 as a <a href="https://gist.github.com/FLamparski/93af1ac4f49c2fde550a36f14a0d9446" rel="nofollow noopener noreferrer" target="_blank" data-v-63ca4eb8 data-v-63ca4eb8>GitHub Gist</a> - there's more on it below.</p>
<h2 id="adding-some-stability-of-the-mechanical-kind" data-v-63ca4eb8 data-v-63ca4eb8><a href="#adding-some-stability-of-the-mechanical-kind" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>Adding some stability, of the mechanical kind</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>To prevent the components from rattling around too much inside the enclosure, I designed a backing board in Fusion 360 and used the laser cutter at the South London Makerspace. This is just a piece of plywood with some holes, allowing me to secure the SDS-011 sensor and the ESP32 breakout board with some nylon screws. I went through a couple of design iterations of these backing boards, trying to fit everything inside the enclosure I had. The final one (highlighted in the screenshot below) packs the components in about 2/3rd of the enclosure, allowing the battery holder to stand on its side as was the case when everything was wibble-wobbling around in the box.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="Fusion 360 screenshot" src="https://thepracticaldev.s3.amazonaws.com/i/sauohsmzudnuoyh9agni.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<p data-v-63ca4eb8 data-v-63ca4eb8>Needless to say, the wibble-wobbling was reduced and the pieces are now much easier to work with if I ever need to take them out of the box.</p>
<h2 id="batteries-included" data-v-63ca4eb8 data-v-63ca4eb8><a href="#batteries-included" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>Batteries included</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>Ah yes, the battery compartment - which I previously used as just a power supply - is now occupied by actual batteries. I sourced those from Poundland power banks, at about Â£2 per ~2000mAh cells. They are pretty easy to get hold of, although I'm pretty sure one of these came pre-shorted - it started getting a bit smoky whenever I put any load on it. PSA: <strong data-v-63ca4eb8 data-v-63ca4eb8>If your batteries get smoky, don't use them!</strong> Lithium batteries are usually quite safe, but if you short them out, they can catch fire and/or explode, so it's best to not mess about with them.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>I also wanted to be able to measure the level of charge in the batteries. The problem I needed to overcome was that, at full charge, a Li-ion battery (or a couple of them in parallel) has a potential of up to 4.3V - which is a full volt higher than the 3.3V level that the ESP32 operates at. I needed to get the battery voltage coming into an analogue pin of the ESP32 to top out at or below 3.3v in order to measure it without damaging the microcontroller. I can drop the voltage by using a voltage divider. I built an example of the circuit <a href="http://tinyurl.com/yxp8ku24" rel="nofollow noopener noreferrer" target="_blank" data-v-63ca4eb8 data-v-63ca4eb8>here</a> in a simulator where you can play around with the battery voltage and see how the divider circuit:</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="" src="https://thepracticaldev.s3.amazonaws.com/i/fl0thmsepdqddn7gvsf6.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<p data-v-63ca4eb8 data-v-63ca4eb8>In the code, I define one of the pins as an analogue pin, and configure the ADC using some ESP32/Arduino functions. I can then read from this pin using the normal <code data-v-63ca4eb8 data-v-63ca4eb8>analogRead</code> function. However, when measuring an analogue value, noise and error creeps in pretty fast - so I decided to measure the battery level several times and average the results:</p>
<div class="nuxt-content-highlight" data-v-63ca4eb8 data-v-63ca4eb8><pre class="language-text line-numbers" data-v-63ca4eb8 data-v-63ca4eb8><code data-v-63ca4eb8 data-v-63ca4eb8>// setup:
  adcAttachPin(BATTERY_PIN);
  analogSetPinAttenuation(BATTERY_PIN, ADC_11db);

// measure:
float get_battery(int n_samples) {
  float sum_reading = 0.0;
  for (int n = 0; n &lt; n_samples; n++) {
    int batteryAdcCount = analogRead(BATTERY_PIN);
    // Battery voltage is given by the ADC as x/4096 * 3.3 for the voltage divider
    // and * 2 for the full voltage.
    sum_reading += ((float) batteryAdcCount) / 4096.0 * 3.3 * 2;
  }

  return sum_reading / ((float) n_samples);
}
</code></pre></div>
<p data-v-63ca4eb8 data-v-63ca4eb8>There is a certain dialectic when it comes to measuring battery levels. The ADC is not magic, and it requires some current to flow while the measurement is taking place. However, you don't want that current to be too high, otherwise you'd be draining the battery rather quickly. This is where the choice of resistor value in your voltage divider is important - too low and you'll burn through the battery, too high and you might not be able to measure it accurately. I picked 36kOhm for mine at pretty much random, but it's high enough that the total current flowing through the divider is about 60uA. Compared to the SDS-011 and ESP32 running at full tilt (peaking at 270mA), it's not very much. If I was crazy about power efficiency, I would experiment more with higher resistor values, and possibly add a transistor to the circuit, so that I can turn off the current if I'm not currently measuring voltage.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>In the end, the battery measurement works pretty well, and the battery itself seems to last at least two full days:</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="Voltage graph showing the battery discharging" src="https://thepracticaldev.s3.amazonaws.com/i/11lrqcaz5yuh8aknr4mh.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<h2 id="on-plugging-in-stuff-wrong" data-v-63ca4eb8 data-v-63ca4eb8><a href="#on-plugging-in-stuff-wrong" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>On plugging in stuff wrong</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>I semi-broke an ESP32 board during the development of this by accidentally plugging it with one pin shifted down in the socket, causing 5V to be applied to its ground pin. Somehow it survived that, but not unscathed - that particular board will no longer wake up from any form of CPU sleep without an external reset, but does otherwise work. Oops. Luckily, I had a spare that worked.</p>
<h2 id="how-to-sleep-right" data-v-63ca4eb8 data-v-63ca4eb8><a href="#how-to-sleep-right" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>How to sleep right</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>Turns out I was using the sleep modes of the ESP32 wrong. Initially I thought of ESP's light sleep as a special case of the Arduino <code data-v-63ca4eb8 data-v-63ca4eb8>delay()</code> function, except where the processor core powers down for the duration of the delay. It's kind of like that, but with one caveat: this also suspends handling of the WiFi connection, causing some instability.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>Furthermore, the ESP also has a deep sleep mode which saves more power, but it actually resets the microcontroller when waking up. I decided that I should use this mode, though - I don't need WiFi between measurements, so I might as well turn everything off. It also simplified the code slightly - I could put everything in <code data-v-63ca4eb8 data-v-63ca4eb8>setup()</code> and rely on the wakeup resets.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>This also made the whole system more stable, and allowed me to more easily add retry features - in the version of the gist current at the time of writing (<a href="https://gist.github.com/FLamparski/93af1ac4f49c2fde550a36f14a0d9446/43b1ba31f619c24c3319f1d5bf3f93049d5d6633" rel="nofollow noopener noreferrer" target="_blank" data-v-63ca4eb8 data-v-63ca4eb8>permalink</a>), if I can't connect to WiFi within a few seconds, I turn everything off and sleep for another 15 seconds. Now, this is still a bit buggy - there can be long stretches when the ESP can't connect at all - so I will need to look at the timeout and other causes of connectivity issues. However, the device will <em data-v-63ca4eb8 data-v-63ca4eb8>eventually</em> reconnect without me having to go and reset it.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="Nope, didn't need that data today..." src="https://thepracticaldev.s3.amazonaws.com/i/cfvsj91nirc2j9hh152x.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<h2 id="some-actual-observations" data-v-63ca4eb8 data-v-63ca4eb8><a href="#some-actual-observations" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>Some actual observations</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>PM2.5 of the carbon species usually comes from burning stuff, right? Well, how about toast? Or indeed, just cooking lunch?</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="Lunchtime spike" src="https://thepracticaldev.s3.amazonaws.com/i/ip1t8u9ve5wugi0z0rmm.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<p data-v-63ca4eb8 data-v-63ca4eb8>Most nights I see a significant increase in presence of PM2.5 species over the night, even though traffic outside my apartment is very light - could this be due to some scattered light affecting the SDS-011 sensor? Or temperatures going down causing dust kicked up high into the atmosphere during the day to settle down?</p>
<p data-v-63ca4eb8 data-v-63ca4eb8><img alt="High measurements overnight" src="https://thepracticaldev.s3.amazonaws.com/i/dyf08orhdvr3xc3mwpzw.png" data-v-63ca4eb8 data-v-63ca4eb8></p>
<h2 id="for-those-playing-along" data-v-63ca4eb8 data-v-63ca4eb8><a href="#for-those-playing-along" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>For those playing along</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>The <a href="https://gist.github.com/FLamparski/93af1ac4f49c2fde550a36f14a0d9446" rel="nofollow noopener noreferrer" target="_blank" data-v-63ca4eb8 data-v-63ca4eb8>gist</a> contains the Arduino sketch running on the ESP32 inside the device. If you want to run it on your own network, you will need to change the WiFi credentials near the top of the file:</p>
<div class="nuxt-content-highlight" data-v-63ca4eb8 data-v-63ca4eb8><pre class="language-text line-numbers" data-v-63ca4eb8 data-v-63ca4eb8><code data-v-63ca4eb8 data-v-63ca4eb8>#define WIFI_SSID "CHANGE ME"
#define WIFI_PASS "CHANGE ME"
</code></pre></div>
<h2 id="as-always-theres-more" data-v-63ca4eb8 data-v-63ca4eb8><a href="#as-always-theres-more" aria-hidden="true" tabindex="-1" data-v-63ca4eb8 data-v-63ca4eb8><span class="icon icon-link" data-v-63ca4eb8 data-v-63ca4eb8></span></a>As always, there's more</h2>
<p data-v-63ca4eb8 data-v-63ca4eb8>The most obvious next step will be to figure out why the ESP is not connecting to WiFi - maybe it's the internal antenna not being very good, or the timeout being too short.</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>Further next steps would be figuring out how to control my measurements for things like cooking - if I am going to use this device to nag my local authority, I should be reasonably sure that the data I get out of it is down to actual traffic related pollution, and not me burning toast. Finally, I should write up that IoT server setup, shouldn't I...</p>
<p data-v-63ca4eb8 data-v-63ca4eb8>See you then - and as always, let me know what you think about this project. I'm still liking it a lot.</p></div></main></div></div></div></div></div><script defer src="/_nuxt/static/1654546987/projects/air-quality-monitor-2/state.js"></script><script src="/_nuxt/f13c776.js" defer></script><script src="/_nuxt/b629c88.js" defer></script><script src="/_nuxt/46dd145.js" defer></script><script src="/_nuxt/6bbb62c.js" defer></script><script src="/_nuxt/32e3f4c.js" defer></script>
  </body>
</html>
