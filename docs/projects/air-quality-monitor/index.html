<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Working on my IoT air quality monitoring setup - Projects - Filip Wieland</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" data-hid="charset" charset="utf-8"><meta data-n-head="ssr" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="ssr" data-hid="apple-mobile-web-app-title" name="apple-mobile-web-app-title" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="ssr" data-hid="og:title" name="og:title" property="og:title" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="filipwieland.com"><meta data-n-head="ssr" data-hid="og:description" name="og:description" property="og:description" content="## Build Setup"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="preconnect" href="https://fonts.gstatic.com"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&display=swap"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap"><link data-n-head="ssr" data-hid="shortcut-icon" rel="shortcut icon" href="/_nuxt/icons/icon_64x64.5f6a36.png"><link data-n-head="ssr" data-hid="apple-touch-icon" rel="apple-touch-icon" href="/_nuxt/icons/icon_512x512.5f6a36.png" sizes="512x512"><link data-n-head="ssr" rel="manifest" href="/_nuxt/manifest.ba28fef4.json" data-hid="manifest"><link rel="preload" href="/_nuxt/fb87f61.js" as="script"><link rel="preload" href="/_nuxt/ec2d4cf.js" as="script"><link rel="preload" href="/_nuxt/5f42bb0.js" as="script"><link rel="preload" href="/_nuxt/452fd64.js" as="script"><link rel="preload" href="/_nuxt/b8d72e5.js" as="script"><style data-vue-ssr-id="4a42b2dc:0 517a8dd7:0 fa7ff0ca:0 248ac8c2:0 e3941c4a:0 4f95ad5b:0 32ef30eb:0">*,:after,:before{box-sizing:border-box;margin:0}body,html{margin:0;padding:0;font-family:Bahnschrift,"Roboto Condensed",-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;font-size:14px;font-weight:400;line-height:1.2;background-color:#000;color:#fff}.text-heading,h1,h2,h3,h4,h5,h6{font-family:Montserrat,Bahnschrift,"Roboto Condensed",-apple-system,BlinkMacSystemFont,"Open Sans","Helvetica Neue",sans-serif;font-weight:800;line-height:1.4;margin-bottom:.5em}p{margin-bottom:.5em}.__layout,.__nuxt,body,html{height:100%}a{text-decoration:none;color:#db28aa}main a{text-decoration:underline}a:visited{color:#b54e99}a:hover,a:visited:hover{color:#ea7fcd}.text-grey{color:#888}code,kbd,pre,span.text-code,textarea{font-size:14px;line-height:1.2;font-family:"Cascadia Code",Inconsolata,"Source Code Pro",Monaco,Menlo,"Courier New",Courier,monospace}main img{max-width:100%}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.layout-projects[data-v-5e315e0e]{background-color:#471d00;height:100vh}.layout-projects .layout-inner[data-v-5e315e0e]{padding:16px;height:calc(100% - 48px);overflow:auto}.navbar[data-v-5875e95e]{display:flex;flex-direction:row;background-color:#000;color:#fff;height:48px;align-items:center}.navbar .link-heading-container[data-v-5875e95e]{flex:3}.navbar .link-heading[data-v-5875e95e]{margin-left:16px;color:#fff}.navbar .link-heading[data-v-5875e95e]:hover,.navbar .link-heading[data-v-5875e95e]:visited{color:#fff}.navbar .link-to-theme[data-v-5875e95e]{flex:1;padding:0 16px;height:100%;display:flex;flex-direction:column;justify-content:center;text-align:center}@media screen and (max-width:400px){.navbar .link-to-theme[data-v-5875e95e]{font-size:12px;padding:0 8px}}.link-to-theme[data-v-fba9cf46]{text-decoration:none;text-transform:uppercase}.link-to-theme.theme-code[data-v-fba9cf46]{background-color:#6049ff;color:#e6e2ff}.link-to-theme.theme-code[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-code.active[data-v-fba9cf46],.link-to-theme.theme-code[data-v-fba9cf46]:hover,.link-to-theme.theme-code[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#1d00e2;box-shadow:inset 0 0 5px 2px rgba(16,0,124,.8);transition:.3s}.link-to-theme.theme-code[data-v-fba9cf46]:visited{color:#e6e2ff}.link-to-theme.theme-music[data-v-fba9cf46]{background-color:#1a9e11;color:#64ed5b}.link-to-theme.theme-music[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-music.active[data-v-fba9cf46],.link-to-theme.theme-music[data-v-fba9cf46]:hover,.link-to-theme.theme-music[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#0b4207;box-shadow:inset 0 0 5px 2px rgba(0,0,0,.8);transition:.3s}.link-to-theme.theme-music[data-v-fba9cf46]:visited{color:#64ed5b}.link-to-theme.theme-projects[data-v-fba9cf46]{background-color:#e05c00;color:#ffb17a}.link-to-theme.theme-projects[data-v-fba9cf46]:link{transition:.3s}.link-to-theme.theme-projects.active[data-v-fba9cf46],.link-to-theme.theme-projects[data-v-fba9cf46]:hover,.link-to-theme.theme-projects[data-v-fba9cf46]:visited:hover{color:#fff;background-color:#7a3200;box-shadow:inset 0 0 5px 2px rgba(20,8,0,.8);transition:.3s}.link-to-theme.theme-projects[data-v-fba9cf46]:visited{color:#ffb17a}.link-to-theme .text-heading[data-v-fba9cf46]{margin-bottom:0}.page[data-v-161252bc]{margin:0 auto;width:100%;max-width:640px}</style><link rel="preload" href="/_nuxt/static/1620048358/projects/air-quality-monitor/state.js" as="script"><link rel="preload" href="/_nuxt/static/1620048358/projects/air-quality-monitor/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1620048358/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="layout-projects" data-v-5e315e0e><div class="navbar" data-v-5875e95e data-v-5e315e0e><div class="link-heading-container" data-v-5875e95e><a href="/" class="text-heading link-heading nuxt-link-active" data-v-5875e95e>Filip Wieland</a></div> <a href="/code" class="link-to-theme theme-code" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Code
    </span></a><a href="/music" class="link-to-theme theme-music" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Music
    </span></a><a href="/projects" class="link-to-theme nuxt-link-active theme-projects active" data-v-fba9cf46 data-v-5875e95e><span class="text-heading" data-v-fba9cf46>
        Projects
    </span></a></div> <div class="layout-inner" data-v-5e315e0e><div class="page" data-v-161252bc data-v-5e315e0e><a href="/projects" class="nuxt-link-active" data-v-161252bc>Projects <span class="text-grey" data-v-161252bc>/</span></a> <h1 data-v-161252bc>Working on my IoT air quality monitoring setup</h1> <main data-v-161252bc><div class="nuxt-content" data-v-161252bc data-v-161252bc><p data-v-161252bc data-v-161252bc><strong data-v-161252bc data-v-161252bc>This post originally appeared on <a href="https://dev.to/minkovsky/working-on-my-iot-air-quality-monitoring-setup-40a5" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>dev.to</a></strong></p>
<p data-v-161252bc data-v-161252bc>Air quality - much has been said about it in the recent years. Research is coming out saying that breathing polluted air <a href="https://www.who.int/airpollution/ambient/health-impacts/en/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>contributes to risk of asthma attacks, allergies, and other health issues</a>. One of the most common pollutants is particulate matter - very fine carbon dust emitted from diesel and some petrol engines. If you live near a high traffic road, you are likely breathing some in right now - and it might be giving you black lung in slow motion.</p>
<p data-v-161252bc data-v-161252bc>On an unrelated note, here's a view from my window:</p>
<p data-v-161252bc data-v-161252bc><img alt="Look at all those lorries" src="https://thepracticaldev.s3.amazonaws.com/i/ktdzv38r0c5runm29ghc.jpg" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>I would like to know how much of this dust - more technically, particulate matter, is in the air outside my window throughout the day. The end goal is to use this information to set up alerts if and when pollution levels exceed government targets, and use this to keep my local authority accountable.</p>
<p data-v-161252bc data-v-161252bc>So, how do I start?</p>
<h1 id="the-sds-011-sensor" data-v-161252bc data-v-161252bc><a href="#the-sds-011-sensor" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>The SDS-011 Sensor</h1>
<p data-v-161252bc data-v-161252bc><img alt="Product shot of the SDS-011, showing the included USB adapter" src="https://thepracticaldev.s3.amazonaws.com/i/8ckn52lit1sl3gw5yzys.jpg" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>The heart of the operation is the nova SDS-011 sensor. It works by blowing air past a laser beam and looking for scattered reflections. It can then isolate scattering caused by specific types of particulate matter - PM2.5 and PM10 - and measure how much of it is in the air, giving its reading in micrograms per cubic metre.</p>
<p data-v-161252bc data-v-161252bc>The sensors are pretty cheap - less than £20 on <a href="https://www.aliexpress.com/wholesale?catId=0&initiative_id=SB_20190605020754&SearchText=sds011" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>AliExpress</a>, with roughly similar prices on Banggood and eBay if shipped from China. Some also throw in a USB adapter for the sensor's serial (UART) interface. Neat! What's not neat is the up to 3 week shipping time, but that's just par for the course when ordering from China.</p>
<p data-v-161252bc data-v-161252bc>By default, the sensor will output its measurements continuously every second. This can be useful if you want to test that it is working with the USB adapter. In fact, I wrote some Python programs that rely on this mode to display the sensor's readings. The simplest one is here in its entirety:</p>
<p data-v-161252bc data-v-161252bc>{% gist <a href="https://gist.github.com/FLamparski/6e5e673b165f19d3e9c5f4b88f0d1ab2" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://gist.github.com/FLamparski/6e5e673b165f19d3e9c5f4b88f0d1ab2</a> %}</p>
<p data-v-161252bc data-v-161252bc>If you also want to plot this data immediately, here's one with matplotlib: <a href="https://gist.github.com/FLamparski/c9d09153183f77c69f8c8ca7ca22e7ab#file-plot-py" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://gist.github.com/FLamparski/c9d09153183f77c69f8c8ca7ca22e7ab#file-plot-py</a></p>
<p data-v-161252bc data-v-161252bc>Great, now I have some data coming in! But I don't want the sensor to be connected to my computer, I'd like to connect it to an ESP32 microcontroller (I have some of these around which I might as well use).</p>
<h1 id="the-esp32" data-v-161252bc data-v-161252bc><a href="#the-esp32" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>The ESP32</h1>
<p data-v-161252bc data-v-161252bc><img alt="Close-up shot of an ESP32 development board" src="https://thepracticaldev.s3.amazonaws.com/i/9dbl0ko0gekb516jw8p5.jpg" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>The ESP32 is a crazy powerful Wi-Fi microcontroller - with the most common variant boasting a dual-core 240MHz CPU, 2 or 4 MiB of flash memory, and 520 KiB of RAM. It's also largely Arduino compatible - and the board library is developed by Espressif as a first-party product.</p>
<p data-v-161252bc data-v-161252bc>It's also really cheap for all that power: you can get it for under £7 with Amazon Prime delivery (or look at the <a href="https://smile.amazon.co.uk/s?k=esp32" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>amazon search</a> for variants with OLED displays, camera attachments, LiPo chargers, etc on board).</p>
<h1 id="the-one-where-i-almost-burn-myself-with-a-soldering-iron" data-v-161252bc data-v-161252bc><a href="#the-one-where-i-almost-burn-myself-with-a-soldering-iron" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>The one where I almost burn myself with a soldering iron</h1>
<p data-v-161252bc data-v-161252bc>To connect the SDS-011 to the ESP32, I am using a perfboard - a PCB with a grid of holes in it, allowing you to quickly assemble your circuit without having to design and make a dedicated PCB. I also needed a 5-pin JST connector to take in the cable supplied with the USB adapter, and I also decided to make a socket for my ESP32 from two pieces of female dupont pin headers. This makes the ESP board stand off from the perfboard, giving me some space to work with underneath it, and also allows me to easily recover the ESP if I ever tear this project down.</p>
<p data-v-161252bc data-v-161252bc>I then soldered some jumper wires on the back side of the board for power and to connect the TX pin of the SDS-011 to the RX2 pin of the ESP, and RX of the SDS-011 to the TX2 pin of the ESP. I made an image in gimp to help me route the wires correctly:</p>
<p data-v-161252bc data-v-161252bc><img alt="Perfboard routing guide" src="https://thepracticaldev.s3.amazonaws.com/i/71g5na42p14bagihv7cp.jpg" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>TX2 and RX2 on the ESP board are available as Serial2 in Arduino sketches. The observant among you may have noticed an extra JST connector exposing the I2C bus - this is for later.</p>
<h1 id="lol-embedded-programming" data-v-161252bc data-v-161252bc><a href="#lol-embedded-programming" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>Lol embedded programming</h1>
<p data-v-161252bc data-v-161252bc>This is not strictly speaking a tutorial, so I'll gloss over how to actually set up ESP32 boards in Arduino - this is documented in the <a href="https://github.com/espressif/arduino-esp32/blob/master/docs/arduino-ide/boards_manager.md" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>arduino-esp32 project itself</a>. The one thing you should note is that this only works with the <strong data-v-161252bc data-v-161252bc>desktop</strong> Arduino IDE, and only if you install the IDE through the MSI installer and <strong data-v-161252bc data-v-161252bc>not from Windows Store</strong>.</p>
<p data-v-161252bc data-v-161252bc>A very simple sketch, which simply formats the incoming data as text and outputs it to the debug serial connection, is also quite short:</p>
<p data-v-161252bc data-v-161252bc>{% gist <a href="https://gist.github.com/FLamparski/25a39a8f5a1c4b3535fe67d7ca39b0ea" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://gist.github.com/FLamparski/25a39a8f5a1c4b3535fe67d7ca39b0ea</a> %}</p>
<p data-v-161252bc data-v-161252bc>So after verifying that this works, I wanted to hunt down some more complete documentation of the SDS-011. The reason for that is that you are not supposed to run the sensor continuously for a long period of time, as it will allow dust of all kinds to accumulate inside, causing it to lose accuracy over time. The manufacturer states that the expected useful lifetime is 8000 hours of operation - so if you don't operate it all the time, you'll get more chooch for your cash. The other reason is that I'd like to run the thing off of lithium batteries at some point, and the SDS-011 uses about a Watt of power when it's running, what with its laser and fan.</p>
<p data-v-161252bc data-v-161252bc>There is a good Arduino library for the SDS family of sensors, which supports the complete protocol they use and presents a nice API for it: <a href="https://github.com/lewapek/sds-dust-sensors-arduino-library" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://github.com/lewapek/sds-dust-sensors-arduino-library</a>. The protocol documentation is <em data-v-161252bc data-v-161252bc>an absolute pig</em> to find though, and I ended up emailing the manufacturer for it. The v1.5 spec is here: <a href="https://drive.google.com/open?id=0B11dfFBNOar5NHNTUVlvcFJPWUctMWZzYWRZU0RiMWxheG04" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://drive.google.com/open?id=0B11dfFBNOar5NHNTUVlvcFJPWUctMWZzYWRZU0RiMWxheG04</a>. If you're implementing your own interface to the sensor, make sure to get the checksum right, otherwise it won't process your commands, and it won't tell you why either. I wrote this before I became aware of that library:</p>
<p data-v-161252bc data-v-161252bc>{% gist <a href="https://gist.github.com/FLamparski/c11a2817351ede4b6c3f2f81d0cd99ca" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>https://gist.github.com/FLamparski/c11a2817351ede4b6c3f2f81d0cd99ca</a> %}</p>
<p data-v-161252bc data-v-161252bc>When it's mostly wired up, it looks like this:</p>
<p data-v-161252bc data-v-161252bc><img alt="Photo of the assembled setup in an enclosure box" src="https://thepracticaldev.s3.amazonaws.com/i/fe0v65vu9fmric2x62ux.jpg" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>I'm powering it through a charge port I hot glued onto the battery compartment.</p>
<p data-v-161252bc data-v-161252bc>At this point, I can start sending all this data to a server. I decided to use an old laptop that I had in my cupboard.</p>
<p data-v-161252bc data-v-161252bc>There is a big gotcha when using the SDS library with the ESP32: It will fail to compile due to <code data-v-161252bc data-v-161252bc>SoftwareSerial</code> not being available in the ESP32 Arduino board package. To remedy that, I downloaded the master branch of the library and put it in my Arduino libraries folder, and then deleted all the code that relied on <code data-v-161252bc data-v-161252bc>SoftwareSerial</code>.</p>
<h1 id="cant-spell-idiot-without-iot" data-v-161252bc data-v-161252bc><a href="#cant-spell-idiot-without-iot" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>Can't spell idiot without IoT</h1>
<p data-v-161252bc data-v-161252bc>The server is running <a href="https://www.influxdata.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>InfluxDB</a>, <a href="https://nodered.org/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Node-RED</a>, and <a href="https://grafana.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Grafana</a> inside Docker. It's also running <a href="https://mosquitto.org/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Mosquitto</a> as the MQTT broker, and <a href="https://github.com/portainer/portainer" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Portainer</a> to give me a nice GUI to the Docker host. And of course, I'm also monitoring the server itself with <a href="https://www.influxdata.com/time-series-platform/telegraf/" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Telegraf</a> running directly on the host. This setup is largely based on <a href="https://www.youtube.com/channel/UCu7_D0o48KbfhpEohoP7YSQ" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>Andreas Speiss</a>'s Raspberry Pi configuration from his videos, however you can mix and match different components - for instance, a friend of mine is using Prometheus instead to monitor her <a href="https://slides.com/daisyt/observability-kitchen" rel="nofollow noopener noreferrer" target="_blank" data-v-161252bc data-v-161252bc>sourdough cultures</a> on a RPi.</p>
<p data-v-161252bc data-v-161252bc>This took a while to set up, not least because I was following several different sources at the same time, many of them written for the RPi and not an x86 machine. However it is mostly working now - and when I'm done tweaking the setup, I will release it on github as a docker-compose application.</p>
<p data-v-161252bc data-v-161252bc>But finally, I was able to connect to the MQTT broker from my ESP32 and start sending data...</p>
<p data-v-161252bc data-v-161252bc>Haha, no. The PubSubClient library I use to connect to the server has a default timeout of 15 seconds, which is way too low for my use case - given that I take about 15 seconds to wake up the sensor and then gather measurement data to average out, and spend another 15 with the CPU sleeping to reduce power use. So I just went into the library and changed the keepalive interval to something more reasonable, like 3 minutes. Afterwards, I started getting data in much more reliably, however the MQTT connection is still kinda patchy and I want to fix that before I move on to adding more sensors to the thing.</p>
<p data-v-161252bc data-v-161252bc>In the end though, I get a good amount of data through, which I can see on my Grafana dashboard:</p>
<p data-v-161252bc data-v-161252bc><img alt="Dashboard showing that a lot of emissions happen at night" src="https://thepracticaldev.s3.amazonaws.com/i/97zdi60t3dochty0u7fk.png" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>For completeness, here's the Node-RED flow:</p>
<p data-v-161252bc data-v-161252bc><img alt="" src="https://thepracticaldev.s3.amazonaws.com/i/dts5hkztljo5x6347nv9.png" data-v-161252bc data-v-161252bc></p>
<p data-v-161252bc data-v-161252bc>And a photo of the setup sucking in air from outside my window to analyse:</p>
<p data-v-161252bc data-v-161252bc><img alt="" src="https://thepracticaldev.s3.amazonaws.com/i/s86ag0q1pn5ho69tajqm.jpg" data-v-161252bc data-v-161252bc></p>
<h1 id="more-stuff" data-v-161252bc data-v-161252bc><a href="#more-stuff" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>More stuff?</h1>
<p data-v-161252bc data-v-161252bc>For further development, I will definitely need to fix the MQTT connection. I don't know what's going on, but sometimes the ESP just plain can't connect to the server, or data gets eaten somewhere in the process. It might be a slightly too aggressive application of sleep modes, or maybe I need to tweak my WiFi settings. This is the challenge of debugging distributed systems - you just plain don't know where the problem actually is, and more often than not, it's actually many problems in many places.</p>
<p data-v-161252bc data-v-161252bc>I also want to actually power the thing off of batteries. I have some 18650 lithium cells I bought at very reasonable prices as Poundland powerbanks (£2 per ~2000mAh cell at a brick and mortar store in the UK? And you get some charge circuitry with it? That's super cheap for hobbyists!), and a holder with appropriate charge circuitry.</p>
<p data-v-161252bc data-v-161252bc>Once I assemble all of that, the box can be made mostly safe against rain water ingress with an O-ring seal along the top and some shrouding of the air inlet and outlet ports. Then I can put it outside and actually close my window.</p>
<p data-v-161252bc data-v-161252bc>Finally, I can also add some I2C sensors for general weather stuff - such as the ever popular BME280. I also thought about adding a display and some sort of touch sensitive pad stuck to the underside of the enclosure cover (which is transparent) to read data directly from the thing, but I think the Grafana interface is nicer.</p>
<p data-v-161252bc data-v-161252bc>And perhaps one day I'll design a cost reduced solution for all of this with a dedicated circuit board and put it up online for people to buy. If I can get the whole thing down to less than £30 I'd be quite happy. Yes, I will add better security if I ever sell this design, don't worry!</p>
<h1 id="closing-thoughts-for-now" data-v-161252bc data-v-161252bc><a href="#closing-thoughts-for-now" aria-hidden="true" tabindex="-1" data-v-161252bc data-v-161252bc><span class="icon icon-link" data-v-161252bc data-v-161252bc></span></a>Closing thoughts for now</h1>
<p data-v-161252bc data-v-161252bc>I like this project. I want to know how much crap I'm breathing in and I now can. I like how this is a nice practical way to consolidate knowledge I learned at uni in two or three separate modules. And I like how quickly I can prototype all of this. I think you should try something like this too - dev hardware is super cheap these days and software is free and relatively straightforward to put together. Electronics knowledge is also easy to obtain on the internet, and proper tools are reasonably priced. Go do the thing!</p></div></main></div></div></div></div></div><script defer src="/_nuxt/static/1620048358/projects/air-quality-monitor/state.js"></script><script src="/_nuxt/fb87f61.js" defer></script><script src="/_nuxt/b8d72e5.js" defer></script><script src="/_nuxt/ec2d4cf.js" defer></script><script src="/_nuxt/5f42bb0.js" defer></script><script src="/_nuxt/452fd64.js" defer></script>
  </body>
</html>
